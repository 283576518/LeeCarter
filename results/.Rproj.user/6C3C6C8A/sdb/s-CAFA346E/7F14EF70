{
    "contents" : "\\documentclass[11pt,oneside, a4paper]{amsart}\n\\usepackage{natbib}\n\n\\usepackage{amsbsy,amsmath}\n\\usepackage{amssymb,amsfonts}\n\\usepackage{bbm}%give 1 with dbl vertical bar \n\\usepackage{booktabs,url,enumerate}\n\\usepackage{color,xcolor}\n\\usepackage{float}\n\\usepackage{tikz}\n\\usepackage{rotating,graphicx,lscape}\n\\usepackage{commath}\n\\usetikzlibrary{arrows,positioning} \n\\usepackage[hypcap]{caption}\n\\newcommand{\\sgn}{\\mathrm{sign}}\n\\usepackage{setspace}\n\n\n\n\\usepackage[top=1.5cm, bottom=1.5cm, left=3.0cm, right=3.0cm]{geometry}\n\n\\DeclareMathOperator{\\Cov}{\\mathbb{C}ov}\n\\DeclareMathOperator{\\Var}{\\mathbb{V}ar}\n\\DeclareMathOperator{\\E}{\\mathbb{E}}\n\\DeclareMathOperator{\\nid}{NID}\n\\DeclareMathOperator{\\N}{\\mathcal{N}}\n\\DeclareMathOperator{\\corr}{corr}\n\\DeclareMathOperator{\\diag}{diag}\n\\onehalfspace\n\n\\newtheorem{theorem}{Theorem}\n\\begin{document}\n\t\n\\title{Replication file for: the stochastic and deterministic components of mortality rates.}   \n\\author{Laurent Callot, Niels Haldrup, and Malene Kallestrup Lamb.}\n\\date{\\today}\n\\maketitle\n\n\nThis document is generated from a \\texttt{knitr} file which contains all the code necessary to replicate the plots and tables in the paper. To replicate these results, simply compile the file with the \\texttt{knitr} package for \\texttt{R}.\n\n\n\n\n\n<<lib,eval=TRUE,echo=FALSE,cache=FALSE,results='hide'>>=\n#\tLoading required libraries. The dependencies should be installed as well. \nlibrary('reshape2')\nlibrary('ggplot2')\nlibrary('xtable')\n\n\n#\tKnitr global chunk settings, modify at your won risk.\nopts_chunk$set( fig.align='center'\n\t       , dev='pdf'\n\t       , fig.width=9, fig.height=9, fig.show='hold'\n\t       , cache=FALSE\n\t       , par=TRUE\n\t       , tidy=TRUE\n\t       , highlight=TRUE\n\t       , echo=FALSE\n\t       , eval=TRUE)\n\n\n@\n\n<<source-subs,cache=FALSE,echo=FALSE>>=\n#Sourcing the subroutines. \n#source('../cohort2/death_subs.R')\n#library('dlc')\nsource('../code/leecarter.R')\nsource('../code/lcrsqr.R')\n\n@\n\nHere is the sample used.\n\n<<smpl,echo=TRUE,results='highlight',cache=TRUE>>=\n# Defining the sample:\nsmpl=list(cn=NULL,gen=NULL,startyear=1950,endyear=2010,minage=0,maxage=90)\n\ncnall <- c('USA','JPN','FRA')\n@\n\n\n\\section*{Figure 1a}\nLog-mortality rates for selected countries and ages.\n\n \n<<fig1a,cache=TRUE,dependson='smpl', fig.width=9, fig.height=9>>=\n\nages <- c(0,1,50,60,80,90)\n\nmm <- NULL\n\nfor(cn in cnall)\n{\n\tfor(gen in c('female','male'))\n\t{\n\tsmpl$cn <- cn\n\tsmpl$gen <- gen\n\t\n\t# loading the data\n\tload(paste('../logm/',smpl$startyear,'/',smpl$cn,'_',smpl$gen,'.rda',sep=''))\n\t\n\tmort <- melt(logm[,ages+1])\n\tcolnames(mort) <- c('Year','Age','value')\n\tmort$Country <- cn\n\tmort$Gender <- gen\n\t\n\tmm <- rbind(mm, mort)\n\t}\n}\n\n\nlmplot <- ggplot(mm,aes(x=Year,y=value,linetype=Country,colour=Country,shape=Gender)) + geom_line() + geom_point(size=2) + facet_wrap(~Age,scale='free',ncol = 3) + theme_bw() + scale_shape_manual(values=c(16,17)) + scale_linetype_manual(values=c(\"solid\", \"dashed\",'dotted')) + theme(legend.box = \"horizontal\",legend.position=\"bottom\") + ylab('Log mortality rate')\n\nprint(lmplot)\n@\n\n\n\\newpage\n\n\\section*{Figure 1b}\nSlope of an age specific linear trend for selected countries.\n\n<<fig1b,cache=TRUE, fig.width=9, fig.height=7,dependson='smpl' >>=\n\nmg <- NULL\n\nfor(cn in cnall)\n{\n\tfor(gen in c('female','male'))\n\t{\n\tsmpl$cn <- cn\n\tsmpl$gen <- gen\n\t\n\t# loading and sotring the data\n\tload(paste('../logm/',smpl$startyear,'/',smpl$cn,'_',smpl$gen,'.rda',sep=''))\n\tdat <- smpl\n\tdat[['logm']] <- logm\n\tlcd\t<- leecarter(dat,trend=TRUE)\n\t\n\tgam <- melt(lcd$gamma)\n\tgam$Age <- dat$minage:dat$maxage\n\tgam$Country <- cn\n\tgam$Gender <- gen\n\t\n\tmg <- rbind(mg, gam)\n\t}\n}\n\n\nlmplot <- ggplot(mg,aes(x=Age,y=value,linetype=Country,colour=Country,shape=Gender)) + geom_line() + geom_point(size=2) + theme_bw() + scale_shape_manual(values=c(16,17)) + scale_linetype_manual(values=c(\"solid\", \"dashed\",'dotted'))+ ylab(expression(hat(gamma)[x]))\n\nprint(lmplot)\n@\n\n\n\\newpage\n\\section*{Figure 2}\nScatter plot of $\\hat{\\mu} \\hat{\\beta}_{CLC}$ versus $\\hat{\\gamma}_{DLC}$.\n\n<<fig2,cache=TRUE, fig.width=9, fig.height=7, dependson='smpl'>>=\nmscp <- NULL\n\nmkk <- NULL\n\nfor(cn in cnall)\n{\n\tfor(gen in c('female','male'))\n\t{\n\tsmpl$cn <- cn\n\tsmpl$gen <- gen\n\t\n\t# loading and sotring the data\n\tload(paste('../logm/',smpl$startyear,'/',smpl$cn,'_',smpl$gen,'.rda',sep=''))\n\tdat <- smpl\n\tdat[['logm']] <- logm\n\t\n\tclc\t<- leecarter(dat,trend=FALSE,ktols=TRUE)\n\tdlc\t<- leecarter(dat,trend=TRUE,ktols=TRUE)\n\t\n\tmu <- (clc$kt[length(clc$kt)] - clc$kt[1])/length(clc$kt)\n\t\n\tmscp <- rbind(mscp,data.frame('Age'=as.numeric(names(clc$beta)),'bm'=matrix(clc$beta*mu,ncol=1),'gm'=dlc$gamma,'Country'=cn,'Gender'=gen))\n\t}\n}\n\ngg.scp <- ggplot(mscp,aes(x=bm,y=gm)) + theme_bw() + geom_point(shape=20)  + geom_abline(intercept = 0, slope = 1, size= 0.5, linetype = 2) + xlab(expression(paste(hat(mu)%*%hat(beta)[x],sep='')))+ ylab(expression(paste(hat(gamma)[x],sep=''))) + facet_grid(Gender~Country,scale='free') \n\nprint(gg.scp)\n@\n\n\n<<whosoutofline,dependson='fig2',cache=TRUE>>=\nmscp$ratio <- mscp$bm/mscp$gm\nmscp[which(mscp$ratio>1.1),]\n\n@\n\n\\newpage\n\\section*{Figure 3}\n\nCLC and DLC loadings on the Lee-Carter trend, $\\widehat{\\beta}$  and $\\widehat{\\tilde{\\beta}}$. The standard errors are too small to be visible. \n\n<<fig3,cache=TRUE, fig.width=9, fig.height=7, dependson='smpl'>>=\nblc <- NULL\ncilc <- NULL\n\nfor(cn in cnall)\n{\n\tfor(gen in c('female','male'))\n\t{\n\tsmpl$cn <- cn\n\tsmpl$gen <- gen\n\t\n\t# loading and sotring the data\n\tload(paste('../logm/',smpl$startyear,'/',smpl$cn,'_',smpl$gen,'.rda',sep=''))\n\tdat <- smpl\n\tdat[['logm']] <- logm\n\t\n\tclc\t<- leecarter(dat,trend=FALSE,ktols=TRUE)\n\tdlc\t<- leecarter(dat,trend=TRUE,ktols=TRUE)\n\t\n\tblc <- rbind(blc,data.frame('Age'=as.numeric(names(clc$beta)),'clc'=matrix(clc$beta,ncol=1),'dlc'=matrix(dlc$beta,ncol=1),'Country'=cn,'Gender'=gen))\n\tcilc <- rbind(cilc,data.frame('Age'=as.numeric(names(clc$beta)),'clc'=matrix(clc$btci,ncol=1),'dlc'=matrix(dlc$btci,ncol=1),'Country'=cn,'Gender'=gen))\n\t}\n}\n\n\nmblc <- melt(blc,id.vars = c(1,4,5))\ncolnames(mblc)[4] <- 'Model'\nmcilc <- melt(cilc,id.vars = c(1,4,5))\nmblc$ci <- mcilc$value\n\n\ngblc <- ggplot(mblc,aes(x=Age,y=value,colour=Model,shape=Model)) + theme_bw() + geom_line() + geom_pointrange(aes(ymin=value - ci,ymax=value + ci)) + facet_grid(Gender~Country,scale='free')  + theme(legend.box = \"horizontal\",legend.position=\"bottom\") \n\nprint(gblc)\n@\n\nIt looks like the constraints imposed by the classical Lee Carter relative to the detrended version leads to over estimating the reduction of mortality for young people and under estimate the decrease for older age groups.  \n\n\\newpage\n\n\\section*{Figure 4}\n\nPlots of the detrended stochastic component ($k_t-\\mu t$) of the 'classic' Lee Carter (CLC) model and stochastic component of the Detrended Lee Carter (DLC) model. \n\n<<fig4,cache=TRUE, fig.width=9, fig.height=7, dependson='smpl'>>=\nkt <- NULL\n\nfor(cn in cnall)\n{\n\tfor(gen in c('female','male'))\n\t{\n\tsmpl$cn <- cn\n\tsmpl$gen <- gen\n\t\n\t# loading and sotring the data\n\tload(paste('../logm/',smpl$startyear,'/',smpl$cn,'_',smpl$gen,'.rda',sep=''))\n\tdat <- smpl\n\tdat[['logm']] <- logm\n\t\n\tclc\t<- leecarter(dat,trend=FALSE,ktols=TRUE)\n\tdlc\t<- leecarter(dat,trend=TRUE,ktols=TRUE)\n\t\n\tktc <- clc$kt\n\tmu <- (clc$kt[length(clc$kt)] - clc$kt[1])/length(clc$kt)\n\t\n\ttrend <- 1:length(ktc)\n\ttrend <- trend - mean(trend)\n\tktcdt <- ktc - mu * trend\n\t\n\tktd <- dlc$kt\n\t\n\tkt <- rbind(kt,data.frame('Year'=smpl$startyear:smpl$endyear,'Country'=cn,'Gender'=gen,'clc'=ktcdt,'dlc'=ktd))\n\t}\n}\n\nmkt <- melt(kt,id.vars = c(1,2,3),measure.vars = c(4,5))\ncolnames(mkt)[4] <- 'Model'\n\ngkt <- ggplot(mkt,aes(x=Year,y=value,colour=Model,shape=Model)) + theme_bw() + geom_line() + geom_point() + facet_grid(Gender~Country,scale='free')  + theme(legend.box = \"horizontal\",legend.position=\"bottom\") \n\nprint(gkt)\n\n@\n\n\n\\newpage\n\\section*{Table X}\n\nAR(1) parameter for $k_t$ and $\\tilde{k}_t$. \n\n<<fig5,cache=TRUE, results='asis', dependson='smpl'>>=\nar <- NULL\n\nfor(cn in c(cnall))\n{\n\tfor(gen in c('female','male'))\n\t{\n\tsmpl$cn <- cn\n\tsmpl$gen <- gen\n\t\n\t# loading and sotring the data\n\tload(paste('../logm/',smpl$startyear,'/',smpl$cn,'_',smpl$gen,'.rda',sep=''))\n\tdat <- smpl\n\tdat[['logm']] <- logm\n\t\t\n\tclc\t<- leecarter(dat,trend=FALSE,ktols=TRUE)\n\tdlc\t<- leecarter(dat,trend=TRUE,ktols=TRUE)\n\t\n\tktc <- clc$kt\n\ttrend <- 0:(length(ktc)-2)\n\tarc <- lm(tail(ktc,-1)~head(ktc,-1))$coefficients[2]\n\tart <- lm(tail(ktc,-1)~head(ktc,-1) + trend)$coefficients[2]\n\t\n\tktd <- dlc$kt\n\tard <- lm(tail(ktd,-1)~head(ktd,-1))$coefficients[2]\n\t\n\tar <- rbind(ar,data.frame('Country'=cn,'Gender'=gen,'clc'=arc,'dlc'=ard))\n\t}\n}\n\nprint(xtable(ar,caption = paste0('AR(1) parameter.'),digits = 3),include.rownames = FALSE)\n@\n\n\n\\newpage\n\\section*{Table Y}\n\n\nWe now compute the $R^2$ for the three models, and also for the CLC and DLC relative to detrended data. \n\n<<rsqr-tab,dependson='smpl',cache=TRUE,results='asis'>>=\nmod.all <- c('clc/dm','dlc/dm','det/dm','clc/dt','dlc/dt')\nrsqr<-array(NA,\n  \t\t\tdim=c(3,length(mod.all),length(cnall)),\n  \t\t\tdimnames=list('gen'=c('female','male','total'),'model'=mod.all,'country'=cnall))\n\nfor(cn in cnall){\n\tsmpl$cn <- cn\n\tfor(gen in c('female','male','total')){\n\t\tsmpl$gen <- gen\n\t\t# loading and sotring the data\n\t\tload(paste('../logm/',smpl$startyear,'/',smpl$cn,'_',smpl$gen,'.rda',sep=''))\n\t\tdat <- smpl\n\t\tdat[['logm']] <- logm\n\t\t\n\t\t#The following function estimates, plot and construct statistic tables for each smpl given.  \n\t\trsqr[gen,,cn] <- lcrsqr(dat)\n\t}\n}\n\ntr2 <- acast(melt(rsqr), country + gen ~ model)\nprint(xtable(tr2,digits=3))\n\n@\n\n\nNotice how the DLC strongly dominates the CLC when compared to detrended data. \n\n\n\\newpage\n\\section{Figure 6?}\n\n\nThis figure shows the trend estimates ($\\hat \\mu \\hat \\beta_t$ for the CLC, $\\hat \\gamma$ for the DLC) considering different starting years for the data (1850,1900,1950) for France. \n\nIt appears clearly that the starting year of the data has a huge impact on the estimated slope of the (implied for the CLC) linear trend. This in turn would result in very different forecasts, those being predominantly driven by the linear trend. This is clearly not a desirable property. \n\n\n\n<<startyear,cache=TRUE,fig.height=6>>=\n\nmsyear <- NULL\n\nsmpl=list(cn='FRA',gen=NULL,startyear=NULL,endyear=2010,minage=0,maxage=90)\nsy <- c(1850,1900,1950)\n\nfor(y in sy)\n{\n\tfor(gen in c('female','male'))\n\t{\n\tsmpl$startyear <- y\n\tsmpl$gen <- gen\n\t\n\t# loading and sotring the data\n\tload(paste('../logm/',smpl$startyear,'/',smpl$cn,'_',smpl$gen,'.rda',sep=''))\n\tdat <- smpl\n\tdat[['logm']] <- logm\n\t\n\tclc\t<- leecarter(dat,trend=FALSE,ktols=TRUE)\n\tdlc\t<- leecarter(dat,trend=TRUE,ktols=TRUE)\n\t\n\tmubeta  <- matrix(clc$beta*(clc$kt[length(clc$kt)] - clc$kt[1])/length(clc$kt),ncol=1)\n\testtrd  <- cbind(mubeta,dlc$gamma)\n\tcolnames(esttrd) <- c('CLC','DLC')\n\t\n\tmsy <- melt(esttrd)\n\tcolnames(msy)[c(1,2)] <- c('Age','Model')\n\tmsy$Gender <- gen\n\tmsy$Startyear <- y \n\t\n\tmsyear <- rbind(msyear, msy)\n\t}\n}\n\nmsyear$Startyear <- factor(msyear$Startyear)\n\nsyplot <- ggplot(msyear,aes(x=Age,y=value,linetype=Startyear,colour=Startyear,shape=Gender)) + geom_line() + geom_point(size=2) + theme_bw() + scale_shape_manual(values=c(16,17)) + scale_linetype_manual(values=c(\"solid\", \"dashed\",'dotted'))+ ylab(expression(hat(gamma)[x])) + facet_wrap(~ Model,ncol=2)\n\nprint(syplot)\n@\n\n\n\\end{document}\n",
    "created" : 1409812556204.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "241798723",
    "id" : "7F14EF70",
    "lastKnownWriteTime" : 1412337995,
    "path" : "~/Dropbox/death/replication/results/pubplots.Rnw",
    "project_path" : "pubplots.Rnw",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "sweave"
}